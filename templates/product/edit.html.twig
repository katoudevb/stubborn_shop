{% extends 'base.html.twig' %}

{% block title %}Modifier le produit{% endblock %}

{% block body %}
<h1>Modifier le produit</h1>

{# Messages flash #}
{% for label, messages in app.flashes %}
    {% for message in messages %}
        <div class="alert alert-{{ label }}">
            {{ message }}
        </div>
    {% endfor %}
{% endfor %}

{{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

<div class="mb-3">
    {{ form_label(form.name) }}
    {{ form_widget(form.name, {'attr': {'class': 'form-control'}}) }}
    {{ form_errors(form.name) }}
</div>

<div class="mb-3">
    {{ form_label(form.price) }}
    {{ form_widget(form.price, {'attr': {'class': 'form-control'}}) }}
    {{ form_errors(form.price) }}
</div>

<div class="mb-3 form-check">
    {{ form_widget(form.featured, {'attr': {'class': 'form-check-input'}}) }}
    {{ form_label(form.featured, null, {'label_attr': {'class': 'form-check-label'}}) }}
    {{ form_errors(form.featured) }}
</div>

<div class="mb-3">
    {{ form_label(form.image) }}
    {{ form_widget(form.image, {'attr': {'class': 'form-control'}}) }}
    {% if product.image %}
        <img src="{{ asset('uploads/' ~ product.image) }}" alt="{{ product.name }}" style="max-width:150px; margin-top:10px;">
    {% endif %}
    {{ form_errors(form.image) }}
</div>

{# Gestion dynamique des stocks #}
<div class="mb-3">
    <div id="stocks-wrapper" data-prototype="{{ form_widget(form.stocks.vars.prototype)|e('html_attr') }}">
        {% for stockForm in form.stocks %}
            <div class="d-flex gap-2 mb-2 align-items-center stock-item">
                {{ form_widget(stockForm.size, {'attr': {'class': 'form-select'}}) }}
                {{ form_widget(stockForm.quantity, {'attr': {'class': 'form-control', 'style':'width:100px;'}}) }}
                <button type="button" class="btn btn-danger btn-sm remove-stock">Supprimer</button>
            </div>
        {% endfor %}
    </div>
    <button type="button" id="add-stock" class="btn btn-secondary btn-sm mt-2">Ajouter une taille</button>
    {{ form_errors(form.stocks) }}
</div>

{# Submit et token CSRF #}
{{ form_widget(form._token) }}
<button type="submit" class="btn btn-primary">Modifier</button>

{{ form_end(form) }}

{# Script JS pour ajouter/supprimer dynamiquement des stocks #}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const wrapper = document.getElementById('stocks-wrapper');
    const addButton = document.getElementById('add-stock');
    let index = wrapper.querySelectorAll('.stock-item').length;

    addButton.addEventListener('click', () => {
        const prototype = wrapper.dataset.prototype;
        const newFormHtml = prototype.replace(/__name__/g, index);

        const div = document.createElement('div');
        div.classList.add('d-flex','gap-2','mb-2','align-items-center','stock-item');
        div.innerHTML = newFormHtml + '<button type="button" class="btn btn-danger btn-sm remove-stock">Supprimer</button>';

        wrapper.appendChild(div);
        index++;
    });

    wrapper.addEventListener('click', (e) => {
        if(e.target && e.target.classList.contains('remove-stock')){
            e.target.closest('.stock-item').remove();
        }
    });
});
</script>
{% endblock %}
